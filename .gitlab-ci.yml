stages:
  - deploy

deploy_dev:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "Deploying dev branch to portal.enitysky.dev on HestiaCP"
    
    # 1. Update source code via Git Pull (Reset hard strategy)
    - ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_PATH_PORTAL && git fetch origin && git reset --hard origin/dev"
    
    # 2. Install dependencies (Production mode)
    - ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_PATH_PORTAL && composer install --no-dev --optimize-autoloader"
    
    # 3. Ensure permissions for FOSSBilling (Adjust paths if necessary)
    # src/data must be writable for cache, logs, etc.
    - ssh $SSH_USER@$SSH_HOST "chmod -R 775 $DEPLOY_PATH_PORTAL/src/data"
    
    # 4. Optional: Run migration or setup if needed
    # FOSSBilling might require manual migration through the UI or specific CLI commands
    # - ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_PATH_PORTAL && php src/bin/console.php database:migrate"
    
  environment:
    name: development
  only:
    - dev
